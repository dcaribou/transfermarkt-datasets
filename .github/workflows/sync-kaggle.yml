name: sync-kaggle

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]
    branches: [master]
  workflow_dispatch:

jobs:
  sync-kaggle:
    runs-on: ubuntu-latest
    container:
      image: dcaribou/transfermarkt-datasets:linux-amd64-master
    defaults:
      run:
        shell: bash -l {0}
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Download prepared data from R2
        run: |
          mkdir -p data/prep
          for file in appearances.csv.gz club_games.csv.gz clubs.csv.gz competitions.csv.gz game_events.csv.gz game_lineups.csv.gz games.csv.gz player_valuations.csv.gz players.csv.gz transfers.csv.gz; do
            curl -sf -o "data/prep/$file" "https://pub-e682421888d945d684bcae8890b0ec20.r2.dev/data/$file"
            echo "Downloaded $file"
          done
      - name: sync
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          just \
            --set syncer sync-kaggle \
            sync
