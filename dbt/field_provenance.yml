# Field-level provenance metadata for curated models.
# Documents which source field(s) contribute to each derived canonical field.
# See docs/field-level-provenance.md for the full specification.
#
# derivation types: direct, coalesce, computed, static
# priority: 1 = primary (transfermarkt), 2 = secondary (openfootball)

version: 1

models:
  - model: competitions
    fields:
      - field: competition_id
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_competitions.competition_id
            priority: 1
          - system: openfootball
            field: "'of_' || stg_openfootball_competitions.competition_id"
            priority: 2

      - field: competition_code
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_competitions.competition_code
            priority: 1
          - system: openfootball
            field: stg_openfootball_competitions.competition_code
            priority: 2

      - field: name
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_competitions.name
            priority: 1
          - system: openfootball
            field: stg_openfootball_competitions.name
            priority: 2

      - field: sub_type
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.sub_type
            priority: 1

      - field: type
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.type
            priority: 1

      - field: country_id
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.country_id
            priority: 1

      - field: country_name
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.country_name
            priority: 1

      - field: domestic_league_code
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.domestic_league_code
            priority: 1

      - field: confederation
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.confederation
            priority: 1

      - field: url
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.url
            priority: 1

      - field: is_major_national_league
        derivation: computed
        sources:
          - system: transfermarkt
            field: "competition_id IN ('ES1','GB1','IT1','FR1','L1')"
            priority: 1

      - field: source_system
        derivation: static
        sources: []

      - field: source_record_id
        derivation: static
        sources: []

      - field: ingested_at
        derivation: static
        sources: []

  - model: clubs
    fields:
      - field: club_id
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_clubs.club_id
            priority: 1
          - system: openfootball
            field: map_club_ids.canonical_club_id
            priority: 2

      - field: club_code
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_clubs.club_code
            priority: 1

      - field: name
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_clubs.name
            priority: 1
          - system: openfootball
            field: stg_openfootball_clubs.name
            priority: 2

      - field: domestic_competition_id
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_clubs.domestic_competition_id
            priority: 1
          - system: openfootball
            field: stg_openfootball_clubs.domestic_competition_id
            priority: 2

      - field: total_market_value
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_clubs.total_market_value
            priority: 1

      - field: squad_size
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_clubs.squad_size
            priority: 1

      - field: average_age
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_clubs.average_age
            priority: 1

      - field: source_system
        derivation: static
        sources: []

      - field: source_record_id
        derivation: static
        sources: []

      - field: ingested_at
        derivation: static
        sources: []

  - model: games
    fields:
      - field: game_id
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.game_id
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.game_id
            priority: 2

      - field: competition_id
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.competition_id
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.competition_id
            priority: 2

      - field: season
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.season
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.season
            priority: 2

      - field: round
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.round
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.round
            priority: 2

      - field: date
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.date
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.date
            priority: 2

      - field: home_club_id
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_games.home_club_id
            priority: 1

      - field: away_club_id
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_games.away_club_id
            priority: 1

      - field: home_club_goals
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.home_club_goals
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.home_club_goals
            priority: 2

      - field: away_club_goals
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: base_games.away_club_goals
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.away_club_goals
            priority: 2

      - field: home_club_name
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: "coalesce(base_clubs.name, base_game_events.club_name)"
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.home_club_name
            priority: 2

      - field: away_club_name
        derivation: coalesce
        sources:
          - system: transfermarkt
            field: "coalesce(base_clubs.name, base_game_events.club_name)"
            priority: 1
          - system: openfootball
            field: stg_openfootball_games.away_club_name
            priority: 2

      - field: aggregate
        derivation: computed
        sources:
          - system: transfermarkt
            field: "home_club_goals || ':' || away_club_goals"
            priority: 1
          - system: openfootball
            field: "home_club_goals || ':' || away_club_goals"
            priority: 2

      - field: competition_type
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_competitions.type
            priority: 1

      - field: stadium
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_games.stadium
            priority: 1

      - field: attendance
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_games.attendance
            priority: 1

      - field: referee
        derivation: direct
        sources:
          - system: transfermarkt
            field: base_games.referee
            priority: 1

      - field: source_system
        derivation: static
        sources: []

      - field: source_record_id
        derivation: static
        sources: []

      - field: ingested_at
        derivation: static
        sources: []
